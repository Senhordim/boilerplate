import 'package:dio/dio.dart';
import 'package:dio/native_imp.dart';
import 'package:get_it/get_it.dart';
import 'package:help/utils/process.provider.dart';

import 'config.dart';

class CustomDio extends DioForNative {
  String _url;

  CustomDio(String url, [BaseOptions options]) : super(options) {
    // Adicionando os interceptors
    interceptors.add(CustomDioInterceptor());
    _url = "${Config.uri}$url";
  }

  Map<String, String> makeHeadersAuthentication(
      {String token, String contentType = "application/json; charset=utf-8"}) {
    Map<String, String> headersMap;
    headersMap = {
      'Content-Type': contentType,
    };
    options.headers = headersMap;
    return headersMap;
  }

  Future<dynamic> getHttp() async {
    final Response _response = await get(_url);
    if (_response.statusCode == 200) {
      return _response.data;
    }
    return null;
  }

  Future<dynamic> postHttp(dynamic data) async {
    final Response _response = await post(_url, data: data);
    if (_response.statusCode == 201) {
      return _response.data;
    }
    return null;
  }

  Future<dynamic> putHttp(dynamic data, String id) async {
    final Response _response = await put(_url, data: data);
    if (_response.statusCode == 200) {
      return _response.data;
    }
    return null;
  }

  Future<dynamic> patchHttp(dynamic data) async {
    final Response _response = await put(_url, data: data);
    if (_response.statusCode == 200) {
      return _response.data;
    }
    return null;
  }

  Future<dynamic> deleteHttp(dynamic data, String id) async {
    final Response _response = await delete(_url, data: data);
    if (_response.statusCode == 200) {
      return _response.data;
    }
    return null;
  }
}

class CustomDioInterceptor extends InterceptorsWrapper {
  final ProcessProvider _processProvider = GetIt.I<ProcessProvider>();
  @override
  Future onRequest(RequestOptions options) {
    options.headers = {'Content-Type': 'application/json'};
    options.connectTimeout = 50000;
    options.receiveTimeout = 50000;
    return super.onRequest(options);
  }

  @override
  Future onResponse(Response response) {
    _processProvider.withSuccess(
        message: response.statusMessage,
        statusCode: response.statusCode,
        httpData: response.data.toString(),
        httpHeader: response.headers.toString());
    return super.onResponse(response);
  }

  @override
  Future onError(DioError err) {
    _processProvider.withError(
        message: err.message,
        statusCode: err.response.statusCode,
        httpData: err.response.data.toString(),
        httpHeader: err.response.headers.toString());
    return super.onError(err);
  }
}
